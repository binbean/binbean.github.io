<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cn" lang="zh-cn">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <link href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/monokai.min.css" rel="stylesheet">
  <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.41" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Sping Cloud中的各种超时配置 &middot; 豆子.学习笔记</title>

  
  <link type="text/css" rel="stylesheet" href="https://binbean.github.io/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://binbean.github.io/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://binbean.github.io/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://binbean.github.io/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="豆子.学习笔记" />

  
</head>

  <body class=" ">
  <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://binbean.github.io/"><h1>豆子.学习笔记</h1></a>
      <br/>
      <br/>
      <p class="lead">
       The Coder of Java 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="https://binbean.github.io/">首页</a> </li>
      <li><a href="https://binbean.github.io//categories/">分类</a> </li>
      <li><a href="https://binbean.github.io//tags/">标签</a> </li>
      
    </ul>

    <br/>
    <br/>
    <p>Copyright (c) 2018, BinBin Wen</p>
    <p>Powered by Hugo 0.40.3</p>
  </div>
</div>

    <div class="content container">
    <div class="post">
  <h1>Sping Cloud中的各种超时配置</h1>
  <span class="post-date">2018-08-16 20:29:23&nbsp;&nbsp;&nbsp;&nbsp;字数：485</span>
  

<h1 id="ribbon超时">Ribbon超时</h1>

<h2 id="全局设置">全局设置</h2>

<pre><code>ribbon:
  ReadTimeout: 10000
  ConnectTimeout: 10000
  #对当前服务的重试次数
  MaxAutoRetries: 0
  #切换相同Server的次数
  MaxAutoRetriesNextServer: 1
  eureka:
    enabled: true
</code></pre>

<p>源码org.springframework.cloud.netflix.zuul.filters.route.support.AbstractRibbonCommand.java</p>

<ul>
<li>RibbonTimeout</li>
</ul>

<pre><code class="language-java">  protected static int getRibbonTimeout(IClientConfig config, String commandKey) {
  		int ribbonTimeout;
  		if (config == null) {
  			ribbonTimeout = RibbonClientConfiguration.DEFAULT_READ_TIMEOUT + RibbonClientConfiguration.DEFAULT_CONNECT_TIMEOUT;
  		} else {
  			int ribbonReadTimeout = getTimeout(config, commandKey, &quot;ReadTimeout&quot;,
  				IClientConfigKey.Keys.ReadTimeout, RibbonClientConfiguration.DEFAULT_READ_TIMEOUT);
  			int ribbonConnectTimeout = getTimeout(config, commandKey, &quot;ConnectTimeout&quot;,
  				IClientConfigKey.Keys.ConnectTimeout, RibbonClientConfiguration.DEFAULT_CONNECT_TIMEOUT);
  			int maxAutoRetries = getTimeout(config, commandKey, &quot;MaxAutoRetries&quot;,
  				IClientConfigKey.Keys.MaxAutoRetries, DefaultClientConfigImpl.DEFAULT_MAX_AUTO_RETRIES);
  			int maxAutoRetriesNextServer = getTimeout(config, commandKey, &quot;MaxAutoRetriesNextServer&quot;,
  				IClientConfigKey.Keys.MaxAutoRetriesNextServer, DefaultClientConfigImpl.DEFAULT_MAX_AUTO_RETRIES_NEXT_SERVER);
  			ribbonTimeout = (ribbonReadTimeout + ribbonConnectTimeout) * (maxAutoRetries + 1) * (maxAutoRetriesNextServer + 1);
  		}
  		return ribbonTimeout;
  	}
</code></pre>

<ul>
<li>HystrixTimeout</li>
</ul>

<pre><code class="language-java">  protected static int getHystrixTimeout(IClientConfig config, String commandKey) {
  		int ribbonTimeout = getRibbonTimeout(config, commandKey);
  		DynamicPropertyFactory dynamicPropertyFactory = DynamicPropertyFactory.getInstance();
  		// 获取默认的hytrix超时时间
  		int defaultHystrixTimeout = dynamicPropertyFactory.getIntProperty(&quot;hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds&quot;,
  			0).get();
  		获取具体服务的hytrix超时时间
  		int commandHystrixTimeout = dynamicPropertyFactory.getIntProperty(&quot;hystrix.command.&quot; + commandKey + &quot;.execution.isolation.thread.timeoutInMilliseconds&quot;,
  			0).get();
  		int hystrixTimeout;
  		if(commandHystrixTimeout &gt; 0) {
  			hystrixTimeout = commandHystrixTimeout;
  		}
  		else if(defaultHystrixTimeout &gt; 0) {
  			hystrixTimeout = defaultHystrixTimeout;
  		} else {
  			hystrixTimeout = ribbonTimeout;
  		}
  		// hytrix超时时间 &lt; ribbon超时时间就会警告
  		if(hystrixTimeout &lt; ribbonTimeout) {
  			LOGGER.warn(&quot;The Hystrix timeout of &quot; + hystrixTimeout + &quot;ms for the command &quot; + commandKey +
  				&quot; is set lower than the combination of the Ribbon read and connect timeout, &quot; + ribbonTimeout + &quot;ms.&quot;);
  		}
  		return hystrixTimeout;
  	}
</code></pre>

<h2 id="局部设置">局部设置</h2>

<pre><code>#与spring.application.name 一致
service-id:
  ribbon:
    ReadTimeout: 1000
    ConnectTimeout: 1000
</code></pre>

<h1 id="zuul超时">Zuul超时</h1>

<blockquote>
<p><a href="http://cloud.spring.io/spring-cloud-static/Edgware.RELEASE/single/spring-cloud.html#_zuul_timeouts">官方文档: http://cloud.spring.io/spring-cloud-static/Edgware.RELEASE/single/spring-cloud.html#_zuul_timeouts</a></p>
</blockquote>

<h2 id="zuul的路由使用ribbon">Zuul的路由使用Ribbon</h2>

<blockquote>
<p>If Zuul is using service discovery than you need to configure these timeouts via Ribbon properties, <code>ribbon.ReadTimeout</code> and <code>ribbon.SocketTimeout</code>.</p>
</blockquote>

<pre><code>ribbon:
  ReadTimeout: 10000
  ConnectTimeout: 10000
  #对当前服务的重试次数
  MaxAutoRetries: 0
  #切换相同Server的次数
  MaxAutoRetriesNextServer: 1
  eureka:
    enabled: true

hystrix:
  threadpool:
    default:
      coreSize: 1000 ##并发执行的最大线程数，默认10
      maxQueueSize: 1000 ##BlockingQueue的最大队列数
      queueSizeRejectionThreshold: 500 ##即使maxQueueSize没有达到，达到queueSizeRejectionThreshold该值后，请求也会被拒绝
  command:
    default:
      execution:
        timeout:
          enabled: true
        isolation:
          thread:
            timeoutInMilliseconds: 50000
</code></pre>

<h2 id="zuul的路由未使用ribbon">Zuul的路由未使用Ribbon</h2>

<p>例如这样的路由配置</p>

<pre><code>zuul:
  routes:
    uaa:
      path: /uaa/**
      strip-prefix: true
      sensitiveHeaders:
      serviceId: wtcp-oauth
</code></pre>

<blockquote>
<p>If you have configured Zuul routes by specifying URLs than you will need to use <code>zuul.host.connect-timeout-millis</code> and <code>zuul.host.socket-timeout-millis</code>.</p>
</blockquote>

<pre><code>zuul:
  host:
    connect-timeout-millis: 5000 #默认2000
    socket-timeout-millis: 30000  #默认10000
</code></pre>

<h1 id="hystrix超时">Hystrix超时</h1>

<p>Hystrix的默认超时时间是1秒。默认开启超时机制。如需关闭Hystrix的超时，可将timeout.enabled设置为false。Hystrix的超时 &gt; 其他组件的超时，否则将导致重试特性失效。</p>

<pre><code>hystrix:
  command:
    default:
      execution:
        timeout:
          enabled: true
        isolation:
          thread:
            timeoutInMilliseconds: 50000
#设置不同微服务的超时时间,CommandKey就是service id：hystrix.command
#hystrix.command.[CommandKey].execution.isolation.thread.timeoutInMilliseconds
</code></pre>

<h1 id="feign的http请求组件">Feign的http请求组件</h1>

<p>源代码：org.springframework.cloud.netflix.feign.ribbon.FeignRibbonClientAutoConfiguration.java</p>

<pre><code>feign:
  hystrix:
    # 在feign中开启hystrix功能，默认情况下feign不开启hystrix功能
    enabled: true
  # 配置httpclient线程池
  httpclient:
    enabled: true
  okhttp:
    enabled: false
</code></pre>

<ul>
<li>默认连接为：HttpURLConnection。</li>
</ul>

<blockquote>
<p>new Default((SSLSocketFactory)null</p>
</blockquote>

<pre><code class="language-java">   //默认配置
   @Bean
      @ConditionalOnMissingBean
      public Client feignClient(CachingSpringLoadBalancerFactory cachingFactory, SpringClientFactory clientFactory) {
          return new LoadBalancerFeignClient(new Default((SSLSocketFactory)null, (HostnameVerifier)null), cachingFactory, clientFactory);
      }
</code></pre>

<ul>
<li><p>可选配置：</p>

<ul>
<li>OkHttpFeignLoadBalancedConfiguration</li>
</ul>

<pre><code class="language-java">@Configuration
    @ConditionalOnClass({OkHttpClient.class})
    @ConditionalOnProperty(
        value = {&quot;feign.okhttp.enabled&quot;},
        matchIfMissing = true
    )
    protected static class OkHttpFeignLoadBalancedConfiguration {
        @Autowired(
            required = false
        )
        private okhttp3.OkHttpClient okHttpClient;
    
        protected OkHttpFeignLoadBalancedConfiguration() {
        }
    
        @Bean
        @ConditionalOnMissingBean({Client.class})
        public Client feignClient(CachingSpringLoadBalancerFactory cachingFactory, SpringClientFactory clientFactory) {
            OkHttpClient delegate;
            if (this.okHttpClient != null) {
                delegate = new OkHttpClient(this.okHttpClient);
            } else {
                delegate = new OkHttpClient();
            }
    
            return new LoadBalancerFeignClient(delegate, cachingFactory, clientFactory);
        }
    }
</code></pre>

<ul>
<li>HttpClientFeignLoadBalancedConfiguration</li>
</ul>

<pre><code class="language-java">@Configuration
    @ConditionalOnClass({ApacheHttpClient.class})
    @ConditionalOnProperty(
        value = {&quot;feign.httpclient.enabled&quot;},
        matchIfMissing = true
    )
    protected static class HttpClientFeignLoadBalancedConfiguration {
        @Autowired(
            required = false
        )
        private HttpClient httpClient;
    
        protected HttpClientFeignLoadBalancedConfiguration() {
        }
    
        @Bean
        @ConditionalOnMissingBean({Client.class})
        public Client feignClient(CachingSpringLoadBalancerFactory cachingFactory, SpringClientFactory clientFactory) {
            ApacheHttpClient delegate;
            if (this.httpClient != null) {
                delegate = new ApacheHttpClient(this.httpClient);
            } else {
                delegate = new ApacheHttpClient();
            }
    
            return new LoadBalancerFeignClient(delegate, cachingFactory, clientFactory);
        }
    }
</code></pre></li>
</ul>

</div>


    </div>

    
  </body>
</html>