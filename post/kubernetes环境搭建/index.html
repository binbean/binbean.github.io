<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cn" lang="zh-cn" >
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <link href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/monokai.min.css" rel="stylesheet">
  
  <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  
  <script type="text/javascript"
        async
        src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">

	
	MathJax.Hub.Config({
	  tex2jax: {
	    inlineMath: [['$','$'], ['\\(','\\)']],
	    displayMath: [['$$','$$'], ['\[','\]']],
	    processEscapes: true,
	    processEnvironments: true,
	    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
	    TeX: { equationNumbers: { autoNumber: "AMS" },
	         extensions: ["AMSmath.js", "AMSsymbols.js"] }
	  }
	});

	MathJax.Hub.Queue(function() {
	    
	    
	    
	    var all = MathJax.Hub.getAllJax(), i;
	    for(i = 0; i < all.length; i += 1) {
	        all[i].SourceElement().parentNode.className += ' has-jax';
	    }
	});
</script>

<style>
code.has-jax {
    font: inherit;
    font-size: 100%;
    background: inherit;
    border: inherit;
    color: #515151;
}
</style>


  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.41" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
  
  <meta content="kubernetes, DevOps" name="keywords">
  <meta content="Kubernetes环境搭建" property="og:title">
  <meta content="Kubernetes环境搭建。" property="og:description">
  

  <title>Kubernetes环境搭建 &middot; Binbean.学习笔记</title>

  
  <link type="text/css" rel="stylesheet" href="http://binbean.github.io/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="http://binbean.github.io/css/poole.css">
  <link type="text/css" rel="stylesheet" href="http://binbean.github.io/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="http://binbean.github.io/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="" rel="alternate" type="application/rss+xml" title="Binbean.学习笔记" />

  
</head>

  <body class=" ">
  <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="http://binbean.github.io/"><h1>Binbean.学习笔记</h1></a>
      <br/>
      <br/>
      <p class="lead">
       The Coder of Java 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="http://binbean.github.io/">首页</a> </li>
      <li><a href="http://binbean.github.io//categories/">分类</a> </li>
      <li><a href="http://binbean.github.io//tags/">标签</a> </li>
      
    </ul>

    <br/>
    <br/>
    <p>Copyright (c) 2018, BinBin Wen</p>
    <p>Powered by Hugo 0.40.3</p>
  </div>
</div>

    <div class="content container">
    <div class="post">
  <h1>Kubernetes环境搭建</h1>
  <span class="post-date">2018-06-15 10:10:44
    
  </span>
  

<h2 id="docker安装">Docker安装</h2>

<p>环境：CentOS/RHEL 7.4+</p>

<h3 id="install-prerequisites">Install prerequisites.</h3>

<pre><code>yum install -y yum-utils device-mapper-persistent-data lvm2
</code></pre>

<h3 id="add-docker-repository">Add docker repository.</h3>

<pre><code>yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo
</code></pre>

<h3 id="install-docker">Install docker.</h3>

<pre><code>yum update &amp;&amp; yum install -y docker-ce-18.06.1.ce
</code></pre>

<h3 id="create-etc-docker-directory">Create /etc/docker directory.</h3>

<pre><code>mkdir /etc/docker
</code></pre>

<h3 id="setup-daemon">Setup daemon.</h3>

<pre><code>cat &gt; /etc/docker/daemon.json &lt;&lt;EOF
{
  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],
  &quot;log-driver&quot;: &quot;json-file&quot;,
  &quot;log-opts&quot;: {
    &quot;max-size&quot;: &quot;100m&quot;
  },
  &quot;storage-driver&quot;: &quot;overlay2&quot;,
  &quot;storage-opts&quot;: [
    &quot;overlay2.override_kernel_check=true&quot;
  ]
}
EOF

mkdir -p /etc/systemd/system/docker.service.d

</code></pre>

<h3 id="restart-docker">Restart docker.</h3>

<pre><code>systemctl daemon-reload &amp;&amp; systemctl enable docker &amp;&amp; systemctl restart docker
</code></pre>

<h2 id="安装环境准备">安装环境准备</h2>

<h4 id="disable-selinux">Disable SELinux</h4>

<pre><code>setenforce 0
sed -i &quot;s/SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/selinux/config
</code></pre>

<h4 id="disable-swap">Disable swap</h4>

<pre><code>swapoff -a
yes | cp /etc/fstab /etc/fstab_bak
cat /etc/fstab_bak |grep -v swap &gt; /etc/fstab
</code></pre>

<h4 id="stop-and-disable-firewalld">Stop and disable firewalld</h4>

<pre><code>systemctl stop firewalld &amp;&amp; systemctl disable firewalld
</code></pre>

<h4 id="add-sysctl-settings">Add sysctl settings</h4>

<pre><code>cat &gt;&gt;/etc/sysctl.d/kubernetes.conf&lt;&lt;EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
vm.swappiness = 0
EOF

sysctl -p
</code></pre>

<h4 id="sync-time">Sync time</h4>

<pre><code># 调整系统 TimeZone
timedatectl set-timezone Asia/Shanghai

# 将当前的 UTC 时间写入硬件时钟
timedatectl set-local-rtc 0

# 重启依赖于系统时间的服务
systemctl restart rsyslog &amp;&amp; systemctl restart crond
yum install -y ntpdate
ntpdate cn.pool.ntp.org
</code></pre>

<h4 id="升级内核">升级内核</h4>

<pre><code>rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm ;yum --enablerepo=elrepo-kernel install kernel-ml-devel kernel-ml -y
# 检查默认内核版本是否大于4.14，否则请调整默认启动参数
grub2-editenv list
#重启以更换内核
reboot
</code></pre>

<h4 id="开启ipvs">开启ipvs</h4>

<pre><code>cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF
#!/bin/bash
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack_ipv4
EOF
chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4
# 
yum install -y ipset ipvsadm
</code></pre>

<h2 id="kubernetes安装">Kubernetes安装</h2>

<h4 id="add-yum-repo-file-for-kubernetes">Add yum repo file for Kubernetes</h4>

<p>Google</p>

<pre><code>cat &gt;&gt;/etc/yum.repos.d/kubernetes.repo&lt;&lt;EOF
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg
        https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
EOF
</code></pre>

<p>Aliyun</p>

<pre><code>cat&gt;&gt;/etc/yum.repos.d/kubrenetes.repo&lt;&lt;EOF
[kubernetes]
name=Kubernetes Repo
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
EOF
</code></pre>

<h4 id="查询下当前版本需要哪些docker-image">查询下当前版本需要哪些docker image</h4>

<pre><code>kubeadm config images list --kubernetes-version v1.11.2
</code></pre>

<h4 id="installing-kubeadm-kubelet-and-kubectl">Installing kubeadm, kubelet and kubectl</h4>

<pre><code>yum install -y kubelet kubeadm kubectl
systemctl enable kubelet &amp;&amp; systemctl start kubelet
</code></pre>

<h4 id="install-kubeadm-master">Install kubeadm master</h4>

<pre><code>kubeadm init --kubernetes-version=v1.13.1 --apiserver-advertise-address 172.17.8.101 --pod-network-cidr=10.244.0.0/16
</code></pre>

<h4 id="install-flannel">Install flannel</h4>

<pre><code>kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
</code></pre>

<h4 id="查看">查看</h4>

<pre><code># 节点状态
kubectl get nodes
# pod状态
kubectl get pods --all-namespaces -o wide

</code></pre>

<h4 id="install-dashboard">Install dashboard</h4>

<p>在$HOME/certs下生成<code>dashboard.key</code>、<code>dashboard.crt</code></p>

<p>1 Self-signed certificate</p>

<pre><code># Generate private key
openssl genrsa -des3 -passout pass:x -out dashboard.pass.key 2048
openssl rsa -passin pass:x -in dashboard.pass.key -out dashboard.key
rm dashboard.pass.key
# Generate certificate signing request
openssl req -new -key dashboard.key -out dashboard.csr
</code></pre>

<p>2 Generate SSL certificate</p>

<pre><code>openssl x509 -req -sha256 -days 365 -in dashboard.csr -signkey dashboard.key -out dashboard.crt
</code></pre>

<p>3 Create secret</p>

<pre><code>kubectl create secret generic kubernetes-dashboard-certs --from-file=$HOME/certs -n kube-system
</code></pre>

<p>4 Deploy Dashboard</p>

<pre><code>kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml
</code></pre>

<h4 id="join-worker-node">Join worker node</h4>

<p>安装kubeadm</p>

<pre><code>yum install -y kubelet kubeadm kubectl
systemctl enable kubelet &amp;&amp; systemctl start kubelet
</code></pre>

<p>安装</p>

<pre><code>kubeadm join 172.17.8.101:6443 --token jy66dz.ywycabclc9s66v4h --discovery-token-ca-cert-hash sha256:3452048d1e4350c609c1e5abb31a57e0814446fa223179e6a62a3ad058a8fc81
</code></pre>

<blockquote>
<p>查看token</p>

<pre><code>&gt; kubeadm token list
&gt; # 重新生成新的token
&gt; kubeadm token create
&gt; kubeadm token create --print-join-command
&gt; # 获取ca证书sha256编码hash值
&gt; openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'
&gt; ```

#### Other

</code></pre>

<p>docker save -o flannel-v0.10.0-amd64.tar quay.io/coreos/flannel:v0.10.0-amd64</p>

<pre><code>
## 从集群中移除Node

节点信息

</code></pre>

<p>kubectl get nodes
NAME    STATUS   ROLES    AGE    VERSION
node1   Ready    master   16m    v1.13.0
node2   Ready    <none>   4m5s   v1.13.0</p>

<pre><code>
例如：从集群中移除node2这个Node执行下面的命令

在master节点上执行

</code></pre>

<p>kubectl drain node2 &ndash;delete-local-data &ndash;force &ndash;ignore-daemonsets
kubectl delete node node2</p>

<pre><code>
在node2上执行

</code></pre>

<p>kubeadm reset
ifconfig cni0 down
ip link delete cni0
ifconfig flannel.1 down
ip link delete flannel.1
rm -rf /var/lib/cni/
 ```</p>
</blockquote>

</div>
<hr />
<blockquote>
<p>本文为学习过程记录，因能力有限，如有错误请赐教……如需转载，请注明出处！<a href="https://binbean.github.io/">https://binbean.github.io</a></p>
</blockquote>




<div id="git-comments"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
  var gitment = new Gitment({
    id: '20180615101044',  
    owner: 'binbean',
    repo: 'Gitment',
    oauth: {
      client_id: '5abe7f2c0a045b632a03',
      client_secret: '5e344f27030ca6bff90af981e47272a1848e3bea',
    }
  })
  gitment.render('git-comments')
</script>
    </div>

    
  </body>
</html>
